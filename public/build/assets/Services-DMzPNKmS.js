var I=Object.defineProperty;var P=(i,l,c)=>l in i?I(i,l,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[l]=c;var E=(i,l,c)=>(P(i,typeof l!="symbol"?l+"":l,c),c);import{A as q,i as y}from"./Adminto-Ckx4Zi2i.js";import{m as b,C as K,c as F,R as t,r as p}from"./CreateReactScript-fryF6WsV.js";import{S as Q}from"./sweetalert2.all-uggxmCrK.js";import{B as V}from"./BasicRest-4QHAt8VX.js";import{U as X}from"./UsersByServicesByBusinessesRest-cXNvIK4h.js";import{U as Y}from"./UsersRest-BKJrLo_s.js";import{S as Z}from"./SelectFormGroup-DgCpZP3V.js";import{M as L}from"./Modal-BlYbLNMj.js";class ee extends V{constructor(){super(...arguments);E(this,"path","services-by-business");E(this,"byBusiness",async c=>{try{const{status:m,result:o}=await b.Fetch(`/api/${this.path}/${c}`);if(!m)throw new Error((o==null?void 0:o.message)||"Ocurrio un error al cargar los servicios vinculados a esta empresa");return o.data}catch(m){return console.error(m),null}});E(this,"enableService",async(c,m)=>{try{const{status:o,result:d}=await b.Fetch(`/api/${this.path}`,{method:"POST",body:JSON.stringify({business:c,service:m})});if(!o)throw new Error((d==null?void 0:d.message)||"Ocurrio un error al habilitar el servicio");return b.Notify.add({icon:"/assets/img/logo-login.svg",title:"Correcto",body:d.message,type:"success"}),d}catch(o){return b.Notify.add({icon:"/assets/img/logo-login.svg",title:"Error",body:o.message,type:"danger"}),null}})}}const te=(i=[],l)=>{const c=[];return i.forEach((m,o)=>{o==0?c.push(m):c.push(l,m)}),c},ae=new Y,O=new ee,h=new X,ne=({businesses:i=[],services:l=[],session:c,APP_DOMAIN:m,APP_PROTOCOL:o})=>{var S,B,R;const d=p.useRef(),w=p.useRef(),N=p.useRef(),[v,U]=p.useState(b.GET.business),[G,T]=p.useState({}),[r,g]=p.useState(null),[J,z]=p.useState([]);p.useEffect(()=>{f()},[v]);const f=async()=>{const e=await O.byBusiness(v),n={};for(const s of e)n[s.service.correlative]=s;return T(n),n},x=({id:e,text:n,element:s})=>{if(!e)return;const a=JSON.parse($(s).attr("data")),u=document.createElement("div");return u.style.display="block",F(u).render(t.createElement(t.Fragment,null,t.createElement("div",{className:"relative d-flex align-items-center py-2"},t.createElement("div",{className:"flex-grow-1 overflow-hidden"},t.createElement("h5",{className:"mt-0 mb-1 text-truncate"},t.createElement("i",{className:"fa fa-building me-1"}),n),t.createElement("p",{className:"d-block text-gray mb-0 font-13 text-truncate"},a.owner.name," ",a.owner.lastname))))),u},A=e=>{const n=$(d.current).find("option:selected"),a=JSON.parse(n.attr("data")).person.document_number;history.pushState(null,null,`/services?business=${a}`),U(a)},_=async(e,n)=>{const{isConfirmed:s}=await Q.fire({title:"¿Estás seguro?",text:"Habilitar el servicio puede aumentar los costos.",icon:"info",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!s)return;e.target.disabled=!0;const a=await O.enableService(v,n);e.target.disabled=!1,a&&(console.log(a),f())},j=async e=>{g(e),$(N.current).modal("show")},H=async()=>{var s,a;const e=[["email","contains",w.current.value]];(s=r==null?void 0:r.users)!=null&&s.length&&e.push("and",["!",te((a=r==null?void 0:r.users)==null?void 0:a.map(({email:u})=>["email","=",u]),"or")]);const n=await ae.paginate({filter:e});console.log(n),z((n==null?void 0:n.data)??[])},W=async e=>{const n=r.id;if(!await h.inviteUser(e,n))return;const a=await f();g(a[r.service.correlative])},M=async e=>{if(!await h.delete(e))return;const s=await f();g(s[r.service.correlative])},D=async({correlative:e})=>{const n=$(d.current).find("option:selected"),s=JSON.parse(n.attr("data"));await h.authorize({service:e,business:s.uuid})&&window.open(`${o}://${e}.${m}/home`)};return t.createElement(t.Fragment,null,t.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{minHeight:"calc(100vh - 135px)"}},t.createElement("div",null,t.createElement("div",{className:"mx-auto",style:{width:"240px"}},t.createElement(Z,{eRef:d,templateResult:x,templateSelection:x,onChange:A},i.map((e,n)=>t.createElement("option",{key:`business-${n}`,value:e.id,data:JSON.stringify(e),selected:b.GET.business==e.person.document_number},e.name)))),t.createElement("hr",{className:"mx-auto",style:{width:"180px"}}),t.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-3"},l.map((e,n)=>{const s=G[e.correlative];return t.createElement("div",{key:`service-${n}`,className:"card mb-0",style:{width:"100%",maxWidth:"360px"}},t.createElement("div",{className:"card-body project-box"},t.createElement("div",{className:"badge bg-primary float-end"},"Gratis"),t.createElement("h4",{className:"mt-0"},t.createElement("a",{href:"#",className:"text-dark",onClick:()=>D(e)},e.name," ",t.createElement("i",{className:"mdi mdi-arrow-top-right"}))),t.createElement("p",{className:"text-success text-uppercase font-13"},e.correlative),t.createElement("p",{className:"text-muted font-13",style:{display:"-webkit-box",WebkitLineClamp:2,textOverflow:"ellipsis",WebkitBoxOrient:"vertical",overflow:"hidden",height:"38px"}},e.description),t.createElement("div",{className:"project-members mb-0"},s?t.createElement(t.Fragment,null,t.createElement("h5",{className:"float-start me-3"},"Equipo :"),t.createElement("div",{className:"avatar-group"},s.users.map((a,u)=>{var k,C;return t.createElement("div",{key:`user-${u}`,className:"avatar-group-item mb-0"},t.createElement(y,{content:`${((k=a==null?void 0:a.person)==null?void 0:k.name)||(a==null?void 0:a.name)} ${((C=a==null?void 0:a.person)==null?void 0:C.lastname)||(a==null?void 0:a.lastname)} ${c.id==a.id&&"(Tú)"}`},t.createElement("img",{src:`/api/profile/thumbnail/${a.relative_id}`,className:"rounded-circle avatar-sm",alt:`${a.name} ${a.lastname}`})))}),t.createElement("div",{className:"avatar-group-item mb-0",style:{cursor:"pointer"},onClick:()=>j(s)},t.createElement(y,{content:"Gestionar usuarios"},t.createElement("img",{src:"/assets/img/plus.svg",className:"rounded-circle avatar-sm",alt:"Gestionar usuarios",style:{backgroundColor:"rgba(255, 255, 255, .5)",border:"1px solid transparent"}}))))):t.createElement(y,{content:"Habilitar servicio"},t.createElement("button",{type:"button",className:"btn btn-sm btn-soft-primary rounded-pill waves-effect waves-light",onClick:a=>_(a,e.correlative)},t.createElement("i",{className:"mdi mdi-plus"})," Habilitar")))))})))),t.createElement(L,{modalRef:N,onSubmit:e=>e.preventDefault(),title:`Gestionar acceso a ${(S=r==null?void 0:r.service)==null?void 0:S.name}`,size:"md",isStatic:!0,hideFooter:!0},t.createElement("div",{className:"d-block btn-group mx-auto",style:{width:"max-content"}},t.createElement("button",{type:"button",className:"btn btn-secondary dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":"false"},t.createElement("i",{className:"fa fa-user-plus"})," Agregar usuarios a este servicio"),t.createElement("div",{className:"dropdown-menu dropdown-menu-center p-2",style:{width:"100%"}},t.createElement("input",{ref:w,className:"form-control mb-2",type:"text",onChange:H}),J.map((e,n)=>{var s,a;return t.createElement(t.Fragment,null,t.createElement("a",{key:`user-${n}`,className:"dropdown-item py-1 px-2 border-t",href:"#",onClick:()=>W(e.email)},t.createElement("p",{className:"mb-0 text-bold text-truncate"},((s=e==null?void 0:e.person)==null?void 0:s.name)||(e==null?void 0:e.name)," ",((a=e==null?void 0:e.person)==null?void 0:a.lastname)||(e==null?void 0:e.lastname)),t.createElement("p",{className:"mb-0 text-muted text-truncate",style:{fontSize:"small"}},e.email)))}))),t.createElement("hr",{className:"mx-auto",style:{maxWidth:"240px",width:"100%"}}),t.createElement("div",null,((B=r==null?void 0:r.users)==null?void 0:B.length)>0?t.createElement("table",{style:{width:"100%"}},t.createElement("tbody",null,(R=r==null?void 0:r.users)==null?void 0:R.map((e,n)=>{var s,a;return t.createElement("tr",{key:`user-${n}`},t.createElement("td",null,t.createElement("img",{src:`/api/profile/thumbnail/${e.relative_id}`,className:"rounded-circle avatar-sm me-1",alt:`${e.name} ${e.lastname}`})),t.createElement("td",null,t.createElement("div",null,t.createElement("h5",{className:"mt-1 mb-1 text-truncate"},((s=e==null?void 0:e.person)==null?void 0:s.name)||(e==null?void 0:e.name)," ",((a=e==null?void 0:e.person)==null?void 0:a.lastname)||(e==null?void 0:e.lastname)),t.createElement("p",{className:"mb-1 text-truncate",style:{fontSize:"small"}},e==null?void 0:e.email))),t.createElement("td",{align:"center"},e.pivot.invitation_accepted==!1&&t.createElement(y,{content:"El usuario no ha aceptado la invitacion"},t.createElement("p",{className:"mb-0 text-danger",style:{fontSize:"small"}},"Pendiente")),t.createElement("button",{className:"btn btn-xs btn-white rounded-pill",onClick:()=>M(e.pivot.id)},t.createElement("i",{className:"fa fa-trash"}))))}))):t.createElement("i",{className:"d-block text-center text-muted"},"- No hay usuarios vinculados -"))))};K((i,l)=>{F(i).render(t.createElement(q,{...l,title:"Servicios"},t.createElement(ne,{...l})))});
